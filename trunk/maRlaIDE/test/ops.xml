<?xml version="1.0" encoding="UTF-8" ?>
<operations version="1">
	<operation name="NOP" list="false">
		<computation>
			<loop type="parent" valueVar="col" nameVar="colName">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<save type="double_array" dynamic_column="colName">col</save>
					</then>
					<else>
						<save type="string_array" dynamic_column="colName">col</save>
					</else>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Divide">
		<query type="column" name="col" prompt="Column?" />
		<query type="number" name="val" prompt="Divide by" />

		<computation>
			<set name="col" rvar="colName" use="name" />
			<set name="val" rvar="val" />

			<loop type="parent" valueVar="currCol" nameVar="currColName">
				<if type="expr" expr="currColName == colName">
					<then>
						<!-- This is the column we're supposed to divide -->
						<save type="double_array" dynamic_column="currColName">currCol / val</save>
					</then>
					<else>
						<!-- Not the column we're working with, just copy it over -->
						<if type="vartype" rvar="currCol" expected="numeric">
							<then>
								<save type="double_array" dynamic_column="currColName">currCol</save>
							</then>
							<else>
								<save type="string_array" dynamic_column="currColName">currCol</save>
							</else>
						</if>
					</else>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Multiply">
		<query type="column" name="col" prompt="Column?" />
		<query type="number" name="val" prompt="Multiply by" />

		<computation>
			<set name="col" rvar="colName" use="name" />
			<set name="val" rvar="val" />

			<loop type="parent" valueVar="currCol" nameVar="currColName">
				<if type="expr" expr="currColName == colName">
					<then>
						<!-- This is the column we're supposed to multiply -->
						<save type="double_array" dynamic_column="currColName">currCol * val</save>
					</then>
					<else>
						<!-- Not the column we're working with, just copy it over -->
						<if type="vartype" rvar="currCol" expected="numeric">
							<then>
								<save type="double_array" dynamic_column="currColName">currCol</save>
							</then>
							<else>
								<save type="string_array" dynamic_column="currColName">currCol</save>
							</else>
						</if>
					</else>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Add">
		<query type="column" name="col" prompt="Column?" />
		<query type="number" name="val" prompt="Add" />

		<computation>
			<set name="col" rvar="colName" use="name" />
			<set name="val" rvar="val" />

			<loop type="parent" valueVar="currCol" nameVar="currColName">
				<if type="expr" expr="currColName == colName">
					<then>
						<!-- This is the column we're supposed to add to -->
						<save type="double_array" dynamic_column="currColName">currCol + val</save>
					</then>
					<else>
						<!-- Not the column we're working with, just copy it over -->
						<if type="vartype" rvar="currCol" expected="numeric">
							<then>
								<save type="double_array" dynamic_column="currColName">currCol</save>
							</then>
							<else>
								<save type="string_array" dynamic_column="currColName">currCol</save>
							</else>
						</if>
					</else>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Subtract">
		<query type="column" name="col" prompt="Column?" />
		<query type="number" name="val" prompt="Subtract" />

		<computation>
			<set name="col" rvar="colName" use="name" />
			<set name="val" rvar="val" />

			<loop type="parent" valueVar="currCol" nameVar="currColName">
				<if type="expr" expr="currColName == colName">
					<then>
						<!-- This is the column we're supposed to add to -->
						<save type="double_array" dynamic_column="currColName">currCol - val</save>
					</then>
					<else>
						<!-- Not the column we're working with, just copy it over -->
						<if type="vartype" rvar="currCol" expected="numeric">
							<then>
								<save type="double_array" dynamic_column="currColName">currCol</save>
							</then>
							<else>
								<save type="string_array" dynamic_column="currColName">currCol</save>
							</else>
						</if>
					</else>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="t-test">
		<query type="checkbox" prompt="Is your data normal?" name="normal" />
		<computation>
			<!-- Run t test on each column and save, plus prepare the top row -->
			<cmd>t = list()</cmd>
			<loop type="parent" valueVar="col" nameVar="colName" indexVar="i">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<cmd>t[[i]] = t.test(col)</cmd>
						<save type="string" column="Column">colName</save>
					</then>
				</if>
			</loop>

			<!-- Save each -->
			<loop type="double_array" loopVar="1:length(t)" indexVar="i">
				<save type="double" column="t">t[[i]]$statistic</save>
				<save type="double" column="DF">t[[i]]$parameter</save>
				<save type="double" column="P-Value">t[[i]]$p.value</save>
				<save type="double" column="Mean">t[[i]]$estimate</save>
				<save type="double" column="Lower CI">t[[i]]$conf.int[1]</save>
				<save type="double" column="Upper CI">t[[i]]$conf.int[2]</save>
				<save type="double" column="alpha">attr(t[[i]]$conf.int, 'conf.level')</save>
			</loop>
		</computation>
	</operation>

	<operation name="Mean">
		<computation>
			<loop type="parent" valueVar="col">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<save type="double" column="mean">mean(col)</save>
					</then>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Standard Deviation">
		<computation>
			<loop type="parent" valueVar="col">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<save type="double" column="sd">sd(col)</save>
					</then>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Sum">
		<computation>
			<loop type="parent" valueVar="col">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<save type="double" column="sum">sum(col)</save>
					</then>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Summation">
		<computation>
			<loop type="parent" valueVar="col">
				<if type="vartype" rvar="col" expected="numeric">
					<then>
						<save type="double" column="sum">sum(col)</save>
					</then>
				</if>
			</loop>
		</computation>
	</operation>

	<operation name="Summary">
		<computation>
			<loop type="parent" indexVar="colName" valueVar="col">
				<cmd>s = summary(col)</cmd>
				<cmd>n = names(s)</cmd>
				<loop type="double_array" loopVar="s" indexVar="i">
					<save type="double" dynamic_column="paste(colName, n[i])">s[i]</save>
				</loop>
			</loop>
		</computation>
	</operation>

	<operation name="XY Plot" plot="true">
		<query type="column" name="x" prompt="X column" />
		<query type="column" name="y" prompt="Y column" />
		<computation>
			<set rvar="x" name="x" />
			<set rvar="y" name="y" />
			<plot>
				<cmd>plot(x,y)</cmd>
			</plot>
		</computation>
	</operation>
</operations>

